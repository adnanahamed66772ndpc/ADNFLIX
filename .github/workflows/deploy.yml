# Deploy ADNFLIX to production VPS on push to main
#
# Required GitHub Actions secrets (Settings → Secrets and variables → Actions):
#   VPS_HOST       - VPS IP or hostname (e.g. 1.2.3.4 or coliningram.site)
#   VPS_USER      - SSH user (e.g. root or ubuntu)
#   SSH_PRIVATE_KEY - Full private key body. On your PC: cat ~/.ssh/id_rsa (or id_ed25519)
#                     Paste the ENTIRE output including -----BEGIN ... KEY----- and -----END ... KEY-----
#                     Do NOT use the .pub file. No extra spaces at start/end.
# Optional: VPS_PORT - if SSH is not on 22 (then uncomment port: in the SSH step)

name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual run from Actions tab

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "::error::Missing secret VPS_HOST. Add it in repo Settings → Secrets and variables → Actions."
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "::error::Missing secret VPS_USER. Add it in repo Settings → Secrets and variables → Actions."
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "::error::Missing secret SSH_PRIVATE_KEY. Add it in repo Settings → Secrets and variables → Actions."
            exit 1
          fi
          echo "Secrets present. Validating SSH key format..."
      - name: Validate SSH private key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | ssh-keygen -y -f /dev/stdin > /dev/null 2>&1 || {
            echo "::error::SSH_PRIVATE_KEY is invalid. Use the PRIVATE key (e.g. id_rsa), not the .pub file. Paste the full key including -----BEGIN and -----END lines. Remove any extra spaces at start or end."
            exit 1
          }
          echo "SSH key format OK."
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /opt/ADNFLIX || { echo "Directory /opt/ADNFLIX not found"; exit 1; }
            if [ ! -f .env ]; then echo "Warning: .env not found. Run ./deploy.sh once on the VPS to create it."; fi
            git fetch origin main
            git reset --hard origin/main
            docker compose --env-file .env up -d --build
            echo "Deploy finished. Frontend and backend updated."
