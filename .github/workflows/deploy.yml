# Deploy ADNFLIX to production VPS with Docker on push to main
#
# One-time VPS setup: clone repo to /opt/ADNFLIX, run ./deploy.sh to create .env and start containers.
# Then add these GitHub Actions secrets (Settings → Secrets and variables → Actions):
#   VPS_HOST        - VPS IP or hostname (e.g. 1.2.3.4 or api.yourdomain.com)
#   VPS_USER       - SSH user (e.g. root or ubuntu)
#   SSH_PRIVATE_KEY - Full private key (cat ~/.ssh/id_rsa). Include -----BEGIN/-----END lines. Not the .pub file.
# Optional: VPS_PORT - SSH port if not 22 (uncomment port in ssh-action)

name: Deploy to Production (Docker)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy via Docker
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then echo "::error::Missing VPS_HOST"; exit 1; fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then echo "::error::Missing VPS_USER"; exit 1; fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then echo "::error::Missing SSH_PRIVATE_KEY"; exit 1; fi
          echo "Secrets OK."
      - name: Validate SSH key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | ssh-keygen -y -f /dev/stdin > /dev/null 2>&1 || {
            echo "::error::Invalid SSH_PRIVATE_KEY. Use full private key, not .pub."
            exit 1
          }
      - name: Deploy via SSH (Docker Compose)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /opt/ADNFLIX || { echo "::error::VPS: /opt/ADNFLIX not found. Clone repo and run ./deploy.sh once."; exit 1; }
            if [ ! -f .env ]; then echo "::error::VPS: .env missing. Run ./deploy.sh on the VPS first to create it."; exit 1; fi
            PREV=$(git rev-parse HEAD 2>/dev/null) || PREV=""
            git fetch origin main
            git reset --hard origin/main
            NEED_BUILD="--build"
            if [ -n "$PREV" ]; then
              if ! git diff --name-only "$PREV" HEAD -- backend/ frontend/ | grep -q . ; then
                NEED_BUILD=""
                echo "No backend/frontend changes, skipping image rebuild."
              fi
            fi
            export DOCKER_BUILDKIT=1
            docker compose --env-file .env up -d $NEED_BUILD
            echo "Waiting for backend health..."
            for i in 1 2 3 4 5 6 7 8 9 10 11 12; do
              curl -sf http://127.0.0.1:3000/health && break
              [ $i -eq 12 ] && { echo "::error::Backend health check failed"; exit 1; }
              sleep 2
            done
            echo "Deploy OK."
